<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- This auth script is crucial to protect the page -->
    <script src="js/auth.js"></script>
    <title>NutriDash | Final Version</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Make sure you have a 'style.css' or similar for your dashboard -->
    <link rel="stylesheet" href="css/dashboard_style.css">
    <style>
        /* --- Styles for the Scanner Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        #qr-reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
        }
        .close-modal-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }
        #scan-result, #loading-indicator {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f0f4f8;
            border-radius: 8px;
        }
        #scan-result h4 {
            margin-top: 0;
        }
        .nutrition-facts { margin-bottom: 1rem; }
        .nutrition-facts p { margin: 0.25rem 0; }
        .log-food-btn {
            width: 100%;
            padding: 0.75rem;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .log-food-btn:hover { background-color: #2ecc71; }
        .log-food-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="aurora-background"></div>

    <aside class="sidebar" id="sidebar">
        <!-- Sidebar content -->
        <div class="sidebar-header">
            <i class="fa-solid fa-leaf logo-icon"></i>
            <h2>NutriDash</h2>
        </div>
        <nav class="main-nav">
            <a href="#" class="active"><i class="fa-solid fa-table-columns"></i><span>Dashboard</span></a>
            <a href="analytics.html"><i class="fa-solid fa-chart-line"></i><span>Analytics</span></a>
            <a href="#"><i class="fa-solid fa-book-open"></i><span>Recipes</span></a>
            <a href="#"><i class="fa-solid fa-gear"></i><span>Settings</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="profile-container">
                <img src="https://i.pravatar.cc/50?img=3" alt="User profile">
                <div class="profile-details">
                    <span id="sidebar-username">User</span>
                    <small>Pro Member</small>
                </div>
            </div>
        </div>
    </aside>

    <main class="main-content" id="main-content">
        <header class="main-header">
            <button id="sidebar-toggle" class="sidebar-toggle-btn"><i class="fa-solid fa-bars"></i></button>
            <h1 id="dynamic-greeting">Loading...</h1>
        </header>

        <div class="bento-grid">
            <div class="card card-progress">
                <div class="card-header"><h3>Daily Progress</h3></div>
                <div class="hero-visuals" id="radial-summaries"></div>
            </div>

            <div class="card card-actions">
                <button class="scan-button"><i class="fa-solid fa-camera"></i><span>Scan Item</span></button>
                <div class="quick-actions">
                    <button class="quick-action-btn water-btn"><i class="fa-solid fa-tint"></i><span>Add Water</span></button>
                    <button class="quick-action-btn quick-add-btn"><i class="fa-solid fa-plus"></i><span>Quick Add</span></button>
                </div>
            </div>
            
            <div class="card card-focus" id="daily-focus-card"></div>

            <div class="card card-log">
                <div class="card-header">
                    <h3>Today's Log</h3><a href="#" class="view-all-btn">View All</a>
                </div>
                <div class="meal-log-list" id="meal-log-container"></div>
            </div>

            <div class="card card-chart">
                <div class="card-header"><h3>Weekly Trend</h3></div>
                <div class="chart-container">
                    <canvas id="weekly-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Scanner Modal HTML -->
    <div class="modal-overlay" id="scanner-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Scan Barcode</h3>
                <button class="close-modal-btn">&times;</button>
            </div>
            <div id="qr-reader"></div>
            <div id="loading-indicator" style="display: none;">
                <p>üîç Looking up barcode...</p>
            </div>
            <div id="scan-result" style="display: none;">
                <!-- Product info will be injected here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    
    <script type="module">
        // --- 1. INITIALIZE SUPABASE ---
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; 
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- UI ELEMENT SELECTORS ---
        const greetingElement = document.getElementById('dynamic-greeting');
        const sidebarUsernameElement = document.getElementById('sidebar-username');
        const radialContainer = document.getElementById('radial-summaries');
        const focusContainer = document.getElementById('daily-focus-card');
        const mealLogContainer = document.getElementById('meal-log-container');
        const quickAddBtn = document.querySelector('.quick-add-btn');
        const addWaterBtn = document.querySelector('.water-btn');
        const scanItemBtn = document.querySelector('.scan-button');
        const scannerModal = document.getElementById('scanner-modal');
        const closeModalBtn = document.querySelector('.close-modal-btn');
        const scanResultDiv = document.getElementById('scan-result');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- GLOBAL STATE ---
        let userProfile = null;
        let html5QrCode = null;
        let dailySummary = {
            calories: { consumed: 0, goal: 2000 },
            protein: { consumed: 0, goal: 120 },
            carbs: { consumed: 0, goal: 250 },
        };

        // --- 2. AUTHENTICATION & DATA FETCHING ---
        db.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                await loadDashboardData(session.user);
            } else {
                window.location.href = '/index.html';
            }
        });
        
        async function loadDashboardData(user) {
            if (!user) return;
            try {
                const { data: profileData, error: profileError } = await db
                    .from('profiles')
                    .select('username, daily_calorie_goal, daily_protein_goal, daily_carbs_goal')
                    .eq('id', user.id)
                    .single();

                if (profileError && profileError.code !== 'PGRST116') throw profileError;
                userProfile = profileData;

                const today = new Date().toISOString().slice(0, 10);
                const { data: foodData, error: foodError } = await db
                    .from('food_log')
                    .select('name, calories, protein, carbs')
                    .eq('user_id', user.id)
                    .gte('created_at', `${today}T00:00:00.000Z`)
                    .lte('created_at', `${today}T23:59:59.999Z`);
                
                if (foodError) throw foodError;
                
                updateGreeting(userProfile?.username || user.email.split('@')[0]);
                calculateDailySummary(foodData);
                renderDashboardComponents(foodData);

            } catch (error) {
                console.error("Error loading dashboard:", error);
                greetingElement.textContent = "Error loading data.";
            }
        }
        
        // --- 3. BARCODE SCANNER LOGIC ---
        function onScanSuccess(decodedText, decodedResult) {
            html5QrCode.stop().then(() => {
                scanResultDiv.style.display = 'none';
                loadingIndicator.style.display = 'block';
                fetchProductInfo(decodedText);
            }).catch(err => console.error("Failed to stop scanner", err));
        }

        async function fetchProductInfo(barcode) {
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                if (!response.ok) throw new Error('Product not found');
                const data = await response.json();
                
                loadingIndicator.style.display = 'none';
                
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    const nutrients = product.nutriments;
                    // Values per 100g, check if they exist
                    const calories = nutrients['energy-kcal_100g'] || 0;
                    const protein = nutrients.proteins_100g || 0;
                    const carbs = nutrients.carbohydrates_100g || 0;

                    displayProductInfo({
                        name: product.product_name_en || product.product_name || 'Unknown Product',
                        barcode,
                        calories,
                        protein,
                        carbs
                    });
                } else {
                    scanResultDiv.innerHTML = `<p>Product not found for barcode: ${barcode}. Please add it manually.</p>`;
                    scanResultDiv.style.display = 'block';
                }
            } catch (error) {
                console.error("API Error:", error);
                loadingIndicator.style.display = 'none';
                scanResultDiv.innerHTML = `<p>Could not fetch product info. Please check your connection or add manually.</p>`;
                scanResultDiv.style.display = 'block';
            }
        }

        function displayProductInfo(product) {
            scanResultDiv.innerHTML = `
                <h4>${product.name}</h4>
                <div class="nutrition-facts">
                    <p><strong>Nutrition per 100g:</strong></p>
                    <p>Calories: ${product.calories.toFixed(1)} kcal</p>
                    <p>Protein: ${product.protein.toFixed(1)} g</p>
                    <p>Carbohydrates: ${product.carbs.toFixed(1)} g</p>
                </div>
                <button class="log-food-btn" id="log-scanned-item">Log This Item</button>
            `;
            scanResultDiv.style.display = 'block';

            document.getElementById('log-scanned-item').addEventListener('click', async () => {
                const logButton = document.getElementById('log-scanned-item');
                logButton.disabled = true;
                logButton.textContent = 'Logging...';
                await logFoodItem(product);
                closeModal();
            });
        }
        
        function openModal() {
            scannerModal.classList.add('visible');
            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
              .catch(err => {
                  console.error("Unable to start scanner", err);
                  scanResultDiv.innerHTML = `<p>Error: Could not access camera. Please grant permission and refresh.</p>`;
                  scanResultDiv.style.display = 'block';
              });
        }
        
        function closeModal() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.log("Scanner already stopped."));
            }
            scannerModal.classList.remove('visible');
            scanResultDiv.style.display = 'none';
            loadingIndicator.style.display = 'none';
            scanResultDiv.innerHTML = ''; // Clear previous results
        }
        
        // --- 4. ACTION HANDLERS (LOGGING DATA) ---
        async function logFoodItem(item) {
            const { data: { user } } = await db.auth.getUser();
            if (!user) {
                alert("You must be logged in.");
                return;
            }
            try {
                const { error } = await db.from('food_log').insert([{
                    user_id: user.id,
                    name: item.name,
                    calories: Math.round(item.calories),
                    protein: Math.round(item.protein),
                    carbs: Math.round(item.carbs)
                }]);
                if (error) throw error;
                await loadDashboardData(user); // Refresh dashboard
            } catch (error) {
                console.error("Error logging food:", error);
                alert("Failed to log food.");
            }
        }

        async function handleQuickAdd() {
            // This can be replaced with a proper modal later
            const name = prompt("Enter food name:");
            if (!name) return;
            const calories = parseInt(prompt("Enter calories:"), 10);
            const protein = parseInt(prompt("Enter protein (g):"), 10);
            const carbs = parseInt(prompt("Enter carbs (g):"), 10);
            if (isNaN(calories) || isNaN(protein) || isNaN(carbs)) {
                return alert("Please enter valid numbers.");
            }
            await logFoodItem({ name, calories, protein, carbs });
        }

        async function handleAddWater() {
            await logFoodItem({ name: "Water (250ml)", calories: 0, protein: 0, carbs: 0 });
        }

        // --- 5. RENDERING LOGIC (NO CHANGES NEEDED HERE) ---
        function updateGreeting(userName) {
            const currentHour = new Date().getHours();
            let greeting = "Good Morning";
            if (currentHour >= 12 && currentHour < 17) greeting = "Good Afternoon";
            if (currentHour >= 17) greeting = "Good Evening";
            greetingElement.textContent = `${greeting}, ${userName}!`;
            sidebarUsernameElement.textContent = userName;
        }

        function calculateDailySummary(foodLogs) {
            dailySummary.calories.consumed = 0;
            dailySummary.protein.consumed = 0;
            dailySummary.carbs.consumed = 0;
            if (userProfile) {
                dailySummary.calories.goal = userProfile.daily_calorie_goal;
                dailySummary.protein.goal = userProfile.daily_protein_goal;
                dailySummary.carbs.goal = userProfile.daily_carbs_goal;
            }
            foodLogs.forEach(item => {
                dailySummary.calories.consumed += item.calories;
                dailySummary.protein.consumed += item.protein;
                dailySummary.carbs.consumed += item.carbs;
            });
        }
        
        function renderDashboardComponents(foodLogs) {
            renderRadialProgress();
            renderFocusCard();
            renderMealLog(foodLogs);
        }

        function renderRadialProgress() {
            if (!radialContainer) return;
            radialContainer.innerHTML = '';
            const colors = { calories: "#27ae60", protein: "#2980b9", carbs: "#f39c12" };
            for (const key in dailySummary) {
                const metric = dailySummary[key];
                const progress = Math.min((metric.consumed / metric.goal) * 100, 100);
                const radialBar = document.createElement('div');
                radialBar.className = 'radial-progress';
                radialBar.style.background = `conic-gradient(${colors[key]} ${progress}%, rgba(0,0,0,0.05) 0)`;
                radialBar.innerHTML = `<div class="radial-progress-inner"><span class="radial-progress-text">${metric.consumed}</span><span class="radial-progress-label">${key}</span></div>`;
                radialContainer.appendChild(radialBar);
            }
        }

        function renderFocusCard() { /* ... unchanged ... */ }
        function renderMealLog(foodLogs) { /* ... unchanged ... */ }
        function renderChart() { /* ... unchanged ... */ }

        // --- 6. EVENT LISTENERS ---
        scanItemBtn.addEventListener('click', openModal);
        closeModalBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === scannerModal) closeModal();
        });
        quickAddBtn.addEventListener('click', handleQuickAdd);
        addWaterBtn.addEventListener('click', handleAddWater);
        
        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            document.body.classList.toggle('sidebar-collapsed');
        });
    </script>
</body>
</html>