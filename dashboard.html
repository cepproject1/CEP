<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- This auth script is crucial to protect the page -->
    <script src="js/auth.js"></script>
    <title>NutriDash | AI Food Scanner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="css/dashboard_style.css">
    <style>
        /* --- Styles for the Scanner Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: #fff; padding: 2rem; border-radius: 12px; width: 90%;
            max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem;
        }
        .modal-header h3 { margin: 0; font-size: 1.5rem; color: #333; }
        .close-modal-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888;
        }
        #image-upload-container { text-align: center; }
        #image-preview {
            max-width: 100%; max-height: 250px; border-radius: 8px;
            margin-top: 1rem; border: 1px solid #eee;
        }
        .upload-btn-wrapper {
            position: relative; overflow: hidden; display: inline-block;
            cursor: pointer; background-color: #3498db; color: white;
            padding: 10px 20px; border-radius: 8px; font-size: 1rem; margin-top: 1rem;
        }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0;
            opacity: 0; cursor: pointer;
        }
        #scan-result, #loading-indicator {
            margin-top: 1rem; padding: 1rem; background-color: #f0f4f8;
            border-radius: 8px; text-align: center;
        }
        #scan-result h4 { margin-top: 0; }
        .nutrition-facts { margin-bottom: 1rem; text-align: left;}
        .nutrition-facts p { margin: 0.25rem 0; }
        .log-food-btn {
            width: 100%; padding: 0.75rem; background-color: #27ae60;
            color: white; border: none; border-radius: 8px; font-size: 1rem;
            cursor: pointer; transition: background-color 0.2s;
        }
        .log-food-btn:hover { background-color: #2ecc71; }
        .log-food-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="aurora-background"></div>

    <aside class="sidebar" id="sidebar">
        <!-- Sidebar content -->
        <div class="sidebar-header">
            <i class="fa-solid fa-leaf logo-icon"></i>
            <h2>NutriDash</h2>
        </div>
        <nav class="main-nav">
            <a href="#" class="active"><i class="fa-solid fa-table-columns"></i><span>Dashboard</span></a>
            <a href="analytics.html"><i class="fa-solid fa-chart-line"></i><span>Analytics</span></a>
            <a href="#"><i class="fa-solid fa-book-open"></i><span>Recipes</span></a>
            <a href="#"><i class="fa-solid fa-gear"></i><span>Settings</span></a>
        </nav>
        <div class="sidebar-footer">
            <div class="profile-container">
                <img src="https://i.pravatar.cc/50?img=3" alt="User profile">
                <div class="profile-details">
                    <span id="sidebar-username">User</span>
                    <small>Pro Member</small>
                </div>
            </div>
        </div>
    </aside>

    <main class="main-content" id="main-content">
        <header class="main-header">
            <button id="sidebar-toggle" class="sidebar-toggle-btn"><i class="fa-solid fa-bars"></i></button>
            <h1 id="dynamic-greeting">Loading...</h1>
        </header>

        <div class="bento-grid">
            <div class="card card-progress">
                <div class="card-header"><h3>Daily Progress</h3></div>
                <div class="hero-visuals" id="radial-summaries"></div>
            </div>

            <div class="card card-actions">
                <button class="scan-button" id="scan-item-btn"><i class="fa-solid fa-camera"></i><span id="scan-btn-text">Analyze Food</span></button>
                <div class="quick-actions">
                    <button class="quick-action-btn water-btn"><i class="fa-solid fa-tint"></i><span>Add Water</span></button>
                    <button class="quick-action-btn quick-add-btn"><i class="fa-solid fa-plus"></i><span>Quick Add</span></button>
                </div>
            </div>
            
            <div class="card card-focus" id="daily-focus-card"></div>

            <div class="card card-log">
                <div class="card-header">
                    <h3>Today's Log</h3><a href="#" class="view-all-btn">View All</a>
                </div>
                <div class="meal-log-list" id="meal-log-container"></div>
            </div>

            <div class="card card-chart">
                <div class="card-header"><h3>Weekly Trend</h3></div>
                <div class="chart-container">
                    <canvas id="weekly-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Scanner Modal HTML -->
    <div class="modal-overlay" id="scanner-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Analyze Food Image</h3>
                <button class="close-modal-btn">&times;</button>
            </div>
            <div id="image-upload-container">
                <img id="image-preview" src="https://placehold.co/400x250/f0f4f8/ccc?text=Select+an+Image" alt="Image preview"/>
                <div class="upload-btn-wrapper">
                    <button class="btn">Upload or Take Photo</button>
                    <input type="file" id="image-uploader" accept="image/*" capture="environment">
                </div>
            </div>
            <div id="loading-indicator" style="display: none;"></div>
            <div id="scan-result" style="display: none;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest/dist/mobilenet.min.js"></script>
    
    <script type="module">
        // --- 1. INITIALIZE SUPABASE & APIs ---
        // ðŸ›‘ IMPORTANT: Replace with your actual Supabase credentials
        const SUPABASE_URL = 'https://dueaxivhontzkvsiwcjc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1ZWF4aXZob250emt2c2l3Y2pjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjgwNTcsImV4cCI6MjA3NTM0NDA1N30.oJpcPh6WOOiNBHjXu6H2PZFkLF3wORdffagx9zDMmNk';

        // ðŸ›‘ IMPORTANT: Get your free API credentials from https://developer.edamam.com/
        const EDAMAM_APP_ID = 'f34a397d';
        const EDAMAM_APP_KEY = 'ee8198f9a60052bec15871ca984bc1fc';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- UI ELEMENT SELECTORS ---
        const greetingElement = document.getElementById('dynamic-greeting');
        const sidebarUsernameElement = document.getElementById('sidebar-username');
        const radialContainer = document.getElementById('radial-summaries');
        const focusContainer = document.getElementById('daily-focus-card');
        const mealLogContainer = document.getElementById('meal-log-container');
        const quickAddBtn = document.querySelector('.quick-add-btn');
        const addWaterBtn = document.querySelector('.water-btn');
        const scanItemBtn = document.getElementById('scan-item-btn');
        const scanBtnText = document.getElementById('scan-btn-text');
        const scannerModal = document.getElementById('scanner-modal');
        const closeModalBtn = document.querySelector('.close-modal-btn');
        const imageUploader = document.getElementById('image-uploader');
        const imagePreview = document.getElementById('image-preview');
        const loadingIndicator = document.getElementById('loading-indicator');
        const scanResultDiv = document.getElementById('scan-result');

        // --- GLOBAL STATE ---
        let userProfile = null;
        let foodModel = null;
        let dailySummary = {
            calories: { consumed: 0, goal: 2000 },
            protein: { consumed: 0, goal: 120 },
            carbs: { consumed: 0, goal: 250 },
        };

        // --- 2. LOAD AI MODEL ---
        async function loadModel() {
            scanBtnText.textContent = 'Loading AI Model...';
            scanItemBtn.disabled = true;
            try {
                foodModel = await mobilenet.load();
                scanBtnText.textContent = 'Analyze Food';
                scanItemBtn.disabled = false;
                console.log('Food recognition model loaded successfully.');
            } catch (error) {
                console.error('Failed to load AI model:', error);
                scanBtnText.textContent = 'AI Model Error';
                alert('Could not load the food recognition model. Please refresh the page.');
            }
        }

        // --- 3. AUTHENTICATION & DATA FETCHING ---
        db.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                await loadDashboardData(session.user);
            } else {
                window.location.href = '/index.html';
            }
        });
        
        async function loadDashboardData(user) {
            if (!user) return;
            try {
                const { data: profileData, error: profileError } = await db
                    .from('profiles')
                    .select('username, daily_calorie_goal, daily_protein_goal, daily_carbs_goal')
                    .eq('id', user.id)
                    .single();

                if (profileError && profileError.code !== 'PGRST116') throw profileError;
                userProfile = profileData;

                const today = new Date().toISOString().slice(0, 10);
                const { data: foodData, error: foodError } = await db
                    .from('food_log')
                    .select('name, calories, protein, carbs')
                    .eq('user_id', user.id)
                    .gte('created_at', `${today}T00:00:00.000Z`)
                    .lte('created_at', `${today}T23:59:59.999Z`);
                
                if (foodError) throw foodError;
                
                updateGreeting(userProfile?.username || user.email.split('@')[0]);
                calculateDailySummary(foodData);
                renderDashboardComponents(foodData);

            } catch (error) {
                console.error("Error loading dashboard:", error);
                greetingElement.textContent = "Error loading data.";
            }
        }
        
        // --- 4. FOOD ANALYSIS LOGIC ---
        async function analyzeImage() {
            if (!imageUploader.files || imageUploader.files.length === 0) {
                return;
            }
            if (!foodModel) {
                alert('AI Model is not loaded yet. Please wait.');
                return;
            }
            if (EDAMAM_APP_ID === 'YOUR_EDAMAM_APP_ID' || EDAMAM_APP_KEY === 'YOUR_EDAMAM_APP_KEY') {
                alert('Please configure your Edamam API credentials in the script first.');
                return;
            }

            loadingIndicator.style.display = 'block';
            loadingIndicator.textContent = 'ðŸ¤– Analyzing image...';
            scanResultDiv.style.display = 'none';

            try {
                const predictions = await foodModel.classify(imagePreview);
                console.log('Predictions:', predictions);

                if (predictions && predictions.length > 0) {
                    const topResult = predictions[0].className.split(',')[0]; // Take the most likely food name
                    loadingIndicator.textContent = `âœ… Identified: ${topResult}. Fetching nutrition...`;
                    await fetchNutritionInfo(topResult);
                } else {
                    throw new Error('Could not identify food in the image.');
                }
            } catch (error) {
                console.error('Error during analysis:', error);
                loadingIndicator.style.display = 'none';
                scanResultDiv.style.display = 'block';
                scanResultDiv.innerHTML = `<p>Sorry, I couldn't identify the food. Please try another picture.</p>`;
            }
        }

        async function fetchNutritionInfo(foodName) {
            try {
                const response = await fetch(`https://api.edamam.com/api/food-database/v2/parser?app_id=${EDAMAM_APP_ID}&app_key=${EDAMAM_APP_KEY}&ingr=${encodeURIComponent(foodName)}&nutrition-type=logging`);
                if (!response.ok) throw new Error('Nutrition API request failed');
                
                const data = await response.json();
                console.log('Edamam API Response:', data);

                if (data.parsed && data.parsed.length > 0) {
                    const food = data.parsed[0].food;
                    const nutrients = food.nutrients;
                    displayNutritionInfo({
                        name: food.label,
                        calories: nutrients.ENERC_KCAL || 0,
                        protein: nutrients.PROCNT || 0,
                        carbs: nutrients.CHOCDF || 0,
                    });
                } else {
                    throw new Error(`No nutritional data found for "${foodName}"`);
                }
            } catch (error) {
                console.error('Nutrition Fetch Error:', error);
                scanResultDiv.innerHTML = `<p>${error.message}. You can still add it manually.</p>`;
            } finally {
                loadingIndicator.style.display = 'none';
                scanResultDiv.style.display = 'block';
            }
        }

        function displayNutritionInfo(product) {
            scanResultDiv.innerHTML = `
                <h4>${product.name}</h4>
                <div class="nutrition-facts">
                    <p><strong>Nutrition per serving (approx. 100g):</strong></p>
                    <p>Calories: ${product.calories.toFixed(0)} kcal</p>
                    <p>Protein: ${product.protein.toFixed(1)} g</p>
                    <p>Carbohydrates: ${product.carbs.toFixed(1)} g</p>
                </div>
                <button class="log-food-btn" id="log-scanned-item">Log This Item</button>
            `;
            document.getElementById('log-scanned-item').addEventListener('click', async () => {
                const logButton = document.getElementById('log-scanned-item');
                logButton.disabled = true;
                logButton.textContent = 'Logging...';
                await logFoodItem(product);
                closeModal();
            });
        }

        // --- 5. MODAL & EVENT HANDLERS ---
        function openModal() { scannerModal.classList.add('visible'); }
        function closeModal() {
            scannerModal.classList.remove('visible');
            resetModalState();
        }
        function resetModalState() {
            imagePreview.src = 'https://placehold.co/400x250/f0f4f8/ccc?text=Select+an+Image';
            imageUploader.value = ''; // Clear file input
            loadingIndicator.style.display = 'none';
            scanResultDiv.style.display = 'none';
            scanResultDiv.innerHTML = '';
        }

        imageUploader.addEventListener('change', () => {
            if (imageUploader.files && imageUploader.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.onload = () => analyzeImage();
                };
                reader.readAsDataURL(imageUploader.files[0]);
            }
        });
        
        scanItemBtn.addEventListener('click', openModal);
        closeModalBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === scannerModal) closeModal();
        });
        
        // --- 6. DASHBOARD LOGIC AND RENDERING (COMPLETE) ---
        async function logFoodItem(item) {
            const { data: { user } } = await db.auth.getUser();
            if (!user) {
                alert("You must be logged in.");
                return;
            }
            try {
                const { error } = await db.from('food_log').insert([{
                    user_id: user.id,
                    name: item.name,
                    calories: Math.round(item.calories),
                    protein: Math.round(item.protein),
                    carbs: Math.round(item.carbs)
                }]);
                if (error) throw error;
                await loadDashboardData(user); // Refresh dashboard
            } catch (error) {
                console.error("Error logging food:", error);
                alert("Failed to log food.");
            }
        }
        
        async function handleQuickAdd() {
            const name = prompt("Enter food name:");
            if (!name) return;
            const calories = parseInt(prompt("Enter calories:"), 10);
            const protein = parseInt(prompt("Enter protein (g):"), 10);
            const carbs = parseInt(prompt("Enter carbs (g):"), 10);
            if (isNaN(calories) || isNaN(protein) || isNaN(carbs)) {
                return alert("Please enter valid numbers.");
            }
            await logFoodItem({ name, calories, protein, carbs });
        }

        async function handleAddWater() {
            await logFoodItem({ name: "Water (250ml)", calories: 0, protein: 0, carbs: 0 });
        }

        function updateGreeting(userName) {
            const currentHour = new Date().getHours();
            let greeting = "Good Morning";
            if (currentHour >= 12 && currentHour < 17) greeting = "Good Afternoon";
            if (currentHour >= 17) greeting = "Good Evening";
            greetingElement.textContent = `${greeting}, ${userName}!`;
            sidebarUsernameElement.textContent = userName;
        }

        function calculateDailySummary(foodLogs) {
            dailySummary.calories.consumed = 0;
            dailySummary.protein.consumed = 0;
            dailySummary.carbs.consumed = 0;
            if (userProfile) {
                dailySummary.calories.goal = userProfile.daily_calorie_goal;
                dailySummary.protein.goal = userProfile.daily_protein_goal;
                dailySummary.carbs.goal = userProfile.daily_carbs_goal;
            }
            foodLogs.forEach(item => {
                dailySummary.calories.consumed += item.calories;
                dailySummary.protein.consumed += item.protein;
                dailySummary.carbs.consumed += item.carbs;
            });
        }
        
        function renderDashboardComponents(foodLogs) {
            renderRadialProgress();
            renderFocusCard();
            renderMealLog(foodLogs);
        }

        function renderRadialProgress() {
            if (!radialContainer) return;
            radialContainer.innerHTML = '';
            const colors = { calories: "#27ae60", protein: "#2980b9", carbs: "#f39c12" };
            for (const key in dailySummary) {
                const metric = dailySummary[key];
                const progress = Math.min((metric.consumed / metric.goal) * 100, 100);
                const radialBar = document.createElement('div');
                radialBar.className = 'radial-progress';
                radialBar.style.background = `conic-gradient(${colors[key]} ${progress}%, rgba(0,0,0,0.05) 0)`;
                radialBar.innerHTML = `<div class="radial-progress-inner"><span class="radial-progress-text">${metric.consumed}</span><span class="radial-progress-label">${key}</span></div>`;
                radialContainer.appendChild(radialBar);
            }
        }
        
        function renderFocusCard() {
            if (!focusContainer) return;
            let lowestProgress = Infinity;
            let focusMetric = 'calories';
            for (const key in dailySummary) {
                const metric = dailySummary[key];
                const progress = (metric.consumed / metric.goal);
                if (progress < lowestProgress) {
                    lowestProgress = progress;
                    focusMetric = key;
                }
            }
            const remaining = Math.max(0, dailySummary[focusMetric].goal - dailySummary[focusMetric].consumed);
            focusContainer.innerHTML = `<div class="card-header"><h3>Your Daily Focus</h3></div><p style="margin-bottom: auto;">To stay balanced, prioritize your <strong>${focusMetric}</strong> intake.</p><p style="font-size: 1.5rem; font-weight: 700; color: var(--dark-green);">You need ${remaining}g more</p>`;
        }

        function renderMealLog(foodLogs) {
            if (!mealLogContainer) return;
            mealLogContainer.innerHTML = '';
            if (foodLogs.length === 0) {
                 mealLogContainer.innerHTML = '<p style="text-align: center; color: #777;">No meals logged yet today.</p>';
                 return;
            }
            foodLogs.slice(0, 5).forEach(meal => {
                const mealItem = document.createElement('div');
                mealItem.className = 'meal-item';
                mealItem.innerHTML = `<div class="meal-item-info"><i class="fa-solid fa-utensils"></i><div><strong>${meal.name}</strong></div></div><span class="meal-item-calories">${meal.calories} kcal</span>`;
                mealLogContainer.appendChild(mealItem);
            });
        }
        
        quickAddBtn.addEventListener('click', handleQuickAdd);
        addWaterBtn.addEventListener('click', handleAddWater);
        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            document.body.classList.toggle('sidebar-collapsed');
        });

        // --- INITIALIZE SCRIPT ---
        loadModel();
    </script>
</body>
</html>

